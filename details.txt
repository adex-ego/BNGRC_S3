================================================================================
                    SYST√àME ACHATS - BNGRC S3
                         D√©tails Complets
================================================================================

üìã R√âSUM√â DU SYST√àME
================================================================================

1. ‚úÖ Achats via dons en argent
   - Les dons en argent servent √† acheter des besoins (En Nature, Mat√©riaux)
   - Chaque besoin a un prix unitaire
   - Exemple: 10 kg de riz √† 5 Ar/kg = 50 Ar total
   - Frais d'achat: 10% configurables ‚Üí 50 Ar + 5 Ar (frais) = 55 Ar TTC
   - ‚ö†Ô∏è Erreur si: pas assez de dons disponibles

2. ‚úÖ Workflow d'achat:
   üìÑ Page /achats ‚Üí Voir les besoins ‚Üí Simuler un achat
   üìÑ Page /simulation ‚Üí V√©rifier les simulations ‚Üí Valider ou supprimer
   üìÑ Page /recapitulatif ‚Üí Voir les stats en temps r√©el


================================================================================
üì¶ MOD√àLES (app/models/)
================================================================================

‚úÖ AchatModel.php
   Classe: AchatModel
   Injection: PDO $db

   FONCTIONS:

   1. getBesoinsRestants(): array
      - R√©cup√®re TOUS les besoins non satisfaits
      - Filtre: t.id_type IN (1, 2) ‚Üí "En Nature" et "Mat√©riaux" seulement
      - Retour: Array de besoins avec:
        * id_besoin, id_besoin_item, nom_besoin, prix_besoin
        * nom_type, quantite_besoin, id_ville, nom_ville
        * nom_region, date_demande, montant_total (quantite √ó prix)

   2. getBesoinsRestantsByVille($id_ville): array
      - R√©cup√®re besoins filtr√©s par ville
      - Param√®tre: $id_ville (INT)
      - M√™me structure que getBesoinsRestants()

   3. getAvailableMoney(): array
      - Liste TOUS les dons en argent disponibles
      - Retour: Array de dons avec:
        * id_don, montant, date_don, statut

   4. getTotalAvailableMoney(): float
      - Somme de TOUS les dons en argent
      - Retour: Total en Ar

   5. getFraisAchat(): float
      - R√©cup√®re le pourcentage de frais depuis config_bngrc
      - D√©faut: 10%
      - Retour: Pourcentage (ex: 10.0)

   6. createAchatSimulation($id_besoin_ville, $quantite, $prix_unitaire, $frais_percent): array
      - CR√âE une simulation (pas d'enregistrement en BD)
      - Param√®tres:
        * $id_besoin_ville: ID du besoin √† acheter
        * $quantite: Quantit√© √† acheter
        * $prix_unitaire: Prix par unit√©
        * $frais_percent: % de frais
      - Retour: Array avec:
        * id_achat, id_besoin_ville, quantite_achetee, prix_unitaire
        * frais_achat_percent, montant_total, statut='simule'
      - ‚ö†Ô∏è Enregistre en BD avec statut='simule'

   7. validateAchat($id_achat): bool
      - Convertit une simulation en achat valid√©
      - Change statut: 'simule' ‚Üí 'valide'
      - Param√®tre: $id_achat (INT)
      - Retour: true/false (succ√®s)

   8. getAchatsSimules(): array
      - R√©cup√®re TOUS les achats en cours de simulation
      - Retour: Array avec d√©tails de chaque simulation

   9. getAchatsValides(): array
      - R√©cup√®re TOUS les achats valid√©s (confirm√©s)
      - Retour: Array avec d√©tails de chaque achat valid√©

   10. getRecapitulatif(): array
       - Calcule les statistiques principales
       - Retour: Array avec:
         * total_besoins: Somme de tous les besoins (quantite √ó prix)
         * besoins_satisfaits: Somme de tous les achats valid√©s
         * besoins_restants: total_besoins - besoins_satisfaits

   11. getAchatSimulation($id_achat): array|null
       - R√©cup√®re UNE simulation par ID
       - Param√®tre: $id_achat (INT)
       - Retour: D√©tails ou null si non trouv√©

   12. deleteAchatSimulation($id_achat): bool
       - Supprime une simulation
       - Param√®tre: $id_achat (INT)
       - Retour: true/false


================================================================================
üéÆ CONTR√îLEURS (app/controllers/)
================================================================================

‚úÖ AchatController.php
   Classe: AchatController
   Injection: AchatModel $achatModel, ..autres models..

   ACTIONS (Fonctions):

   1. index()
      - Affiche la page /achats
      - R√©cup√®re:
        * Tous les besoins restants ‚Üí $besoins
        * Toutes les villes ‚Üí $villes
        * Total argent disponible ‚Üí $montant_disponible
      - Rendu: achats.php avec ces donn√©es

   2. simulate() [POST /achats/simulate] - AJAX
      - Cr√©e une simulation d'achat
      - Param√®tres POST:
        * id_besoin_ville: ID du besoin s√©lectionn√©
        * quantite: Quantit√© √† acheter
      - V√©rifie:
        * L'argent disponible est suffisant
        * La quantit√© est valide
      - Actions:
        * Appelle createAchatSimulation()
        * Retourne JSON: {id_achat: X} ou {error: "message"}
      - Retour: JSON

   3. validate() [POST /achats/validate] - AJAX
      - Valide une simulation
      - Param√®tres POST:
        * id_achat: ID de la simulation √† valider
      - Actions:
        * Appelle validateAchat()
        * Enregistre le lien don ‚Üî achat
      - Retour: JSON {success: true} ou {error: "message"}

   4. showSimulation()
      - Affiche la page /simulation
      - R√©cup√®re:
        * Toutes les simulations en cours ‚Üí $achats_simules
        * Total argent disponible ‚Üí $montant_dispo
      - Rendu: simulation.php avec ces donn√©es

   5. deleteSimulation() [POST /achats/delete-simulation] - AJAX
      - Supprime une simulation
      - Param√®tres POST:
        * id_achat: ID de la simulation √† supprimer
      - Actions:
        * Appelle deleteAchatSimulation()
      - Retour: JSON {success: true} ou {error: "message"}

   6. showRecap()
      - Affiche la page /recapitulatif
      - R√©cup√®re:
        * Statistiques g√©n√©rales ‚Üí $recap
        * Tous les achats valid√©s ‚Üí $achats_valides
      - Rendu: recapitulatif.php avec ces donn√©es

   7. recap() [GET /api/recap] - AJAX JSON
      - Retourne les statistiques en JSON
      - Param√®tres: Aucun
      - R√©cup√®re:
        * getRecapitulatif() ‚Üí {total_besoins, besoins_satisfaits, besoins_restants}
      - Retour: JSON pour actualisation AJAX


================================================================================
üìÑ VUES (app/views/)
================================================================================

‚úÖ achats.php (/achats)
   Structure:
   - Bootstrap HTML + header.php
   - Filtrage par ville (dropdown)
   - Table avec besoins disponibles:
     ‚Ä¢ Nom besoin, Type, Quantit√©, Prix/U, Total, Ville, Date, Bouton Acheter
   - Formulaire d'achat:
     ‚Ä¢ Input quantit√©
     ‚Ä¢ Aper√ßu montant HT + frais + TTC
     ‚Ä¢ Bouton "Simuler l'Achat"
   
   Comportement JavaScript:
   - Filtre par ville masque les lignes non correspondantes
   - Clic "Acheter" ‚Üí s√©lectionne le besoin + affiche aper√ßu
   - Input quantit√© ‚Üí calcule le total en temps r√©el
   - Submit formulaire ‚Üí POST /achats/simulate via AJAX
   - Succ√®s ‚Üí Redirect vers /simulation

‚úÖ simulation.php (/simulation)
   Structure:
   - Bootstrap HTML + header.php
   - Affiche montant disponible
   - Table des simulations en cours:
     ‚Ä¢ ID, Besoin, Qt√©, Prix/U, Montant HT, Frais, Total, Actions
   - Boutons par simulation:
     ‚Ä¢ ‚úì Valider (POST /achats/validate)
     ‚Ä¢ ‚úï Supprimer (POST /achats/delete-simulation)
   - Affiche total des simulations
   - Lien retour vers /achats
   
   Comportement JavaScript:
   - Valider ‚Üí Confirmation ‚Üí POST validate ‚Üí reload
   - Supprimer ‚Üí Confirmation ‚Üí POST delete ‚Üí reload
   - Page vide si aucune simulation

‚úÖ recapitulatif.php (/recapitulatif)
   Structure:
   - Bootstrap HTML + header.php
   - 3 cartes statistiques:
     ‚Ä¢ Total des besoins (Ar)
     ‚Ä¢ Besoins satisfaits (Ar)
     ‚Ä¢ Besoins restants (Ar)
   - Table des achats valid√©s:
     ‚Ä¢ ID, Besoin, Qt√©, Prix/U, Montant HT, Frais, Total, Date, Statut
   - Bouton "Actualiser" ‚Üí AJAX GET /api/recap ‚Üí refresh stats sans reload
   - Liens retour vers /achats et /home
   
   Comportement JavaScript:
   - Au chargement: fetch /api/recap ‚Üí remplir les stats
   - Clic Actualiser: fetch /api/recap ‚Üí update des stats


================================================================================
üõ£Ô∏è ROUTES (app/config/routes.php)
================================================================================

Ajout√©es:

GET  /achats                     ‚Üí AchatController::index
POST /achats/simulate            ‚Üí AchatController::simulate
POST /achats/validate            ‚Üí AchatController::validate
GET  /simulation                 ‚Üí AchatController::showSimulation
POST /achats/delete-simulation   ‚Üí AchatController::deleteSimulation
GET  /recapitulatif              ‚Üí AchatController::showRecap
GET  /api/recap                  ‚Üí AchatController::recap

Toutes les routes sont prot√©g√©es par AuthMiddleware (login requis)


================================================================================
üíæ BASE DE DONN√âES
================================================================================

Tables utilis√©es:

1. besoin_bngrc
   - id_besoin (PK)
   - id_type (FK ‚Üí besoin_type_bngrc)
   - nom_besoin
   - prix_besoin

2. besoin_ville_bngrc
   - id_besoin (PK)
   - id_besoin_item (FK ‚Üí besoin_bngrc.id_besoin)
   - quantite_besoin
   - id_ville (FK ‚Üí ville_bngrc)
   - date_demande

3. dons_bngrc
   - id_don (PK)
   - id_besoin_item (FK)
   - quantite_don (montant en Ar)

4. besoin_type_bngrc
   - id_type (PK)
   - nom_type (Ex: "En Nature", "Mat√©riaux", "Argent")

5. ville_bngrc
   - id_ville (PK)
   - id_region (FK)
   - nom_ville

6. achats_bngrc [NOUVELLE]
   - id_achat (PK)
   - id_besoin_ville (FK ‚Üí besoin_ville_bngrc)
   - quantite_achetee
   - prix_unitaire
   - frais_achat_percent
   - montant_total
   - date_achat
   - statut ('simule' ou 'valide')

7. dons_utilises_bngrc [NOUVELLE]
   - id_don_utilise (PK)
   - id_achat (FK ‚Üí achats_bngrc)
   - id_don (FK ‚Üí dons_bngrc)
   - montant_utilise


================================================================================
üìã CHECKLIST - T√ÇCHES ACHATS
================================================================================

BACKEND:
‚úÖ AchatModel.php cr√©√© avec 12 fonctions
‚úÖ AchatController.php cr√©√© avec 7 actions
‚úÖ Routes cr√©√©es (7 routes)
‚úÖ Int√©gration avec header.php

FRONTEND:
‚úÖ achats.php cr√©√©e (s√©lection + simulation)
‚úÖ simulation.php cr√©√©e (r√©vision + validation)
‚úÖ recapitulatif.php cr√©√©e (statistiques)
‚úÖ Navigation mise √† jour

TESTS MANUELS √Ä FAIRE:
[ ] Acc√©der √† /achats ‚Üí voir les besoins
[ ] Filtrer par ville ‚Üí v√©rifier le filtrage
[ ] Simuler un achat ‚Üí v√©rifier la cr√©ation
[ ] Acc√©der √† /simulation ‚Üí voir les simulations
[ ] Valider une simulation ‚Üí v√©rifier le changement statut
[ ] Supprimer une simulation ‚Üí v√©rifier la suppression
[ ] Acc√©der √† /recapitulatif ‚Üí voir les stats
[ ] Cliquer "Actualiser" ‚Üí v√©rifier rafra√Æchissement AJAX
[ ] V√©rifier erreur si argent insuffisant
[ ] V√©rifier les calculs montant + frais


================================================================================
üîó FLUX UTILISATEUR COMPLET
================================================================================

1. Utilisateur acc√®de √† /achats
   ‚Üí Voit liste des besoins non satisfaits
   ‚Üí Filtre par ville (optionnel)
   ‚Üí Clique "Acheter" sur un besoin

2. Formulaire d'achat appara√Æt
   ‚Üí Entre la quantit√©
   ‚Üí Voit le montant HT + frais + TTC
   ‚Üí Clique "Simuler l'Achat"

3. AJAX envoie POST /achats/simulate
   ‚Üí Serveur cr√©e une simulation (statut='simule')
   ‚Üí Page redirige vers /simulation

4. Page /simulation affiche les simulations
   ‚Üí Utilisateur peut:
     a) Cliquer ‚úì Valider ‚Üí POST /achats/validate ‚Üí statut='valide'
     b) Cliquer ‚úï Supprimer ‚Üí POST delete ‚Üí suppression

5. Utilisateur acc√®de √† /recapitulatif
   ‚Üí Voit les statistiques
   ‚Üí Peut cliquer "Actualiser" pour mise √† jour AJAX
   ‚Üí Voit la table des achats valid√©s


================================================================================
üîß TECHNOLOGIES UTILIS√âES
================================================================================

Backend:
- PHP 8.5.3
- PDO (Prepared Statements)
- Flight Framework
- Session-based Auth

Frontend:
- Bootstrap 5 (CSS Framework)
- Vanilla JavaScript (ES6)
- Fetch API (AJAX)
- HTML5 Forms


================================================================================
üìù NOTES IMPORTANTES
================================================================================

1. Tous les besoins filtr√©s ont id_type IN (1, 2)
   ‚Üí Exclut type 3 (Argent)

2. Les frais d'achat sont configurables via config_bngrc
   ‚Üí Stock√© dans colonne frais_achat_percent

3. Les simulations restent en BD avec statut='simule'
   ‚Üí Permettent de reprendre plus tard

4. L'actualisation du r√©capitulatif est en AJAX
   ‚Üí Pas de reload complet de la page

5. Validation des montants c√¥t√© serveur ET client
   ‚Üí S√©curit√© + UX

6. Toutes les pages utilisent le header.php commun
   ‚Üí Navigation coh√©rente


================================================================================
                            FIN DES D√âTAILS
================================================================================
